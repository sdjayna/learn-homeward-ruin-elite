<!doctype html>
<html lang="en" id="html-root">
<head>
  <meta charset="utf-8">
  <title>Learning App</title>
  <meta name="description" content="A learning app with spaced repetition">
  <base href="/">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#1976d2">
  <!-- Apple PWA meta tags -->
  <link rel="apple-touch-icon" href="assets/icons/icon-192x192.png">
  <!-- Add accessibility meta tags -->
  <meta name="apple-mobile-web-app-title" content="LHRE">
  <style>
    /* Basic accessibility styles */
    :focus {
      outline: 3px solid #1976d2;
      outline-offset: 2px;
    }
    
    @media (prefers-reduced-motion: reduce) {
      * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
        scroll-behavior: auto !important;
      }
    }
    
    body {
      line-height: 1.5;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    }
    
    /* High contrast mode support */
    @media (forced-colors: active) {
      button, select, a {
        forced-color-adjust: none;
      }
    }
  </style>
</head>
<body>
  <!-- PWA status is now logged to console only -->
  <main>
    <app-root></app-root>
  </main>
  <footer role="contentinfo" style="padding: 10px; margin-top: 20px; text-align: center; font-size: 0.9em; color: #6c757d;">
    <p id="footer-text">© 2025 Learn Homeward Ruin Elite</p>
  </footer>

  <script>
    // Language support
    const translations = {
      en: {
        pageTitle: 'Learn Homeward Ruin Elite',
        languageLabel: 'Language:',
        pwaReady: 'PWA Ready: Service Worker is registered and active!',
        swSupported: 'Service Worker is supported in this browser.',
        swNotRegistered: 'Service Worker supported but not yet registered.',
        swNotSupported: 'Service Worker is not supported in this browser. PWA functionality will be limited.',
        cacheComplete: 'PWA Ready: Service Worker is active and cache is complete!',
        checkingStatus: 'Checking PWA and Service Worker status...',
        footerText: '© 2025 Learn Homeward Ruin Elite'
      },
      fr: {
        pageTitle: 'Apprendre Homeward Ruin Elite',
        languageLabel: 'Langue:',
        pwaReady: 'PWA Prête : Le Service Worker est enregistré et actif !',
        swSupported: 'Le Service Worker est pris en charge dans ce navigateur.',
        swNotRegistered: 'Service Worker pris en charge mais pas encore enregistré.',
        swNotSupported: 'Le Service Worker n\'est pas pris en charge dans ce navigateur. Les fonctionnalités PWA seront limitées.',
        cacheComplete: 'PWA Prête : Le Service Worker est actif et le cache est complet !',
        checkingStatus: 'Vérification du statut PWA et du Service Worker...',
        footerText: '© 2025 Apprendre Homeward Ruin Elite'
      },
      es: {
        pageTitle: 'Aprende Homeward Ruin Elite',
        languageLabel: 'Idioma:',
        pwaReady: '¡PWA Lista: El Service Worker está registrado y activo!',
        swSupported: 'El Service Worker es compatible con este navegador.',
        swNotRegistered: 'Service Worker compatible pero aún no registrado.',
        swNotSupported: 'El Service Worker no es compatible con este navegador. La funcionalidad PWA será limitada.',
        cacheComplete: '¡PWA Lista: El Service Worker está activo y el caché está completo!',
        checkingStatus: 'Comprobando el estado de PWA y Service Worker...',
        footerText: '© 2025 Aprende Homeward Ruin Elite'
      }
    };
    
    // Get user's preferred language or use stored preference
    function getPreferredLanguage() {
      // First check if there's a stored preference
      const storedLang = localStorage.getItem('preferredLanguage');
      if (storedLang && ['en', 'fr', 'es'].includes(storedLang)) {
        console.log('Using stored language preference:', storedLang);
        return storedLang;
      }
      
      // Then check browser language
      const browserLang = navigator.language.split('-')[0];
      const detectedLang = ['en', 'fr', 'es'].includes(browserLang) ? browserLang : 'en';
      console.log('Detected browser language:', browserLang, '→ Using:', detectedLang);
      
      // Store this as the initial preference
      localStorage.setItem('preferredLanguage', detectedLang);
      
      return detectedLang;
    }
    
    // Change language function
    function changeLanguage(lang) {
      // Store the preference
      localStorage.setItem('preferredLanguage', lang);
      
      // Update HTML lang attribute
      document.getElementById('html-root').setAttribute('lang', lang);
      
      // Update language selector
      document.getElementById('language').value = lang;
      
      // Update all translated text
      updateTranslatedText(lang);
      
      // Announce language change to screen readers
      const announcement = document.createElement('div');
      announcement.setAttribute('aria-live', 'assertive');
      announcement.setAttribute('role', 'status');
      announcement.style.position = 'absolute';
      announcement.style.width = '1px';
      announcement.style.height = '1px';
      announcement.style.overflow = 'hidden';
      
      // Set the announcement text in the new language
      if (lang === 'en') {
        announcement.textContent = 'Language changed to English';
      } else if (lang === 'fr') {
        announcement.textContent = 'Langue changée en français';
      } else if (lang === 'es') {
        announcement.textContent = 'Idioma cambiado a español';
      }
      
      document.body.appendChild(announcement);
      
      // Remove the announcement after it's been read
      setTimeout(() => {
        document.body.removeChild(announcement);
      }, 3000);
      
      // Dispatch event for Angular components to react
      window.dispatchEvent(new CustomEvent('languageChanged', { 
        detail: { language: lang } 
      }));
    }
    
    // Update all translated text elements
    function updateTranslatedText(lang) {
      // Update page title
      document.getElementById('page-title').textContent = translations[lang].pageTitle;
      document.title = translations[lang].pageTitle;
      
      // Update language label
      document.getElementById('language-label').textContent = translations[lang].languageLabel;
      
      // Update PWA status text
      const statusBanner = document.getElementById('pwa-status');
      const currentState = statusBanner.getAttribute('data-state') || 'checking';
      statusBanner.textContent = translations[lang][currentState];
      
      // Update footer text
      document.getElementById('footer-text').textContent = translations[lang].footerText;
    }
    
    // Initialize PWA
    document.addEventListener('DOMContentLoaded', function() {
      
      // Set initial language based on browser settings
      const initialLang = getPreferredLanguage();
      document.getElementById('language').value = initialLang;
      document.getElementById('html-root').setAttribute('lang', initialLang);
      
      // Update all translated text with initial language
      updateTranslatedText(initialLang);
      
      // Notify that language has been set
      console.log('Initial language set to:', initialLang);
      
      // Dispatch language change event for Angular components
      window.dispatchEvent(new CustomEvent('languageChanged', { 
        detail: { language: initialLang, source: 'initialization' } 
      }));
      
      // Check if service worker is supported
      if ('serviceWorker' in navigator) {
        console.debug('PWA: Service Worker is supported in this browser');
        
        // Check if service worker is registered
        navigator.serviceWorker.getRegistration().then(registration => {
          if (registration) {
            console.debug('PWA: Service Worker is registered and active');
          } else {
            console.debug('PWA: Service Worker supported but not yet registered');
          }
        });
        
        // Listen for messages from the service worker
        navigator.serviceWorker.addEventListener('message', event => {
          if (event.data && event.data.type === 'CACHE_COMPLETE') {
            console.debug('PWA: Service Worker cache is complete');
          }
        });
      } else {
        console.debug('PWA: Service Worker is not supported in this browser');
      }
    });
  </script>
</body>
</html>
